%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% File: splitData_v02.m
%%% Spiliting data for unbalanced data 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function [trainingIdx, testingIdx, label] = splitData_v02(label,  foldsPermut, per , ClassOption)

%%% Parameters
nFolds = size(foldsPermut,1);
nTry = size(foldsPermut,2);
labelOriginal = label ; 
%%% Find what are the label
labels = unique(label);


    % % %%% Convert the sparse matrix to full matrix
    % % data = full(data); 
    % % %%% Normalize the data between 0 and 1
    % % data = mat2gray(data); 
    %%% Sort the label   
    % % %%% Reorganize the data regarding the index
    % % data = (data(idxFull,:));

%%% Clear data
clear idxFull;


if strcmpi (ClassOption, 'M_D')
        %%% Replace the label by -1 and 1
        label(label==labels(1)) = -1;
        label(label==labels(2)) = 1;
%         [label, idxFull] = sort(label);
                
        %%% Find the index which is splitting the dataset -1;1
        idxLimit = find(labelOriginal==labels(1), 1, 'first');

        %%% Make cross-validation on negative example
        idxPos = crossvalind('Kfold', label(1:idxLimit-1), nFolds);
        
        %%% Make cross-validation on positive example
        idxNeg = crossvalind('Kfold', label(idxLimit:end), nFolds);
        lengthPos = length(idxPos); 
        lengthNeg = length(idxNeg); 
        class1Instances = ceil((length(idxPos)/10)*per) ; 
        class2Instances = ceil((length(idxNeg)/10)*per) ; 
        Remclass1Instances = lengthPos - class1Instances; 
        Remclass2Instances = lengthNeg - class2Instances;
        
        trainingIdx = zeros(class1Instances + class2Instances,10);
        testingIdx = zeros(Remclass1Instances + Remclass2Instances,10);
        
        PosMatrix = zeros(length(idxPos), nTry); 
        NegMatrix = zeros(length(idxNeg), nTry); 
        for i = 1 : nTry 
        temArrayPos = []; 
        temArrayNeg = []; 
            for j = 1 : size(foldsPermut,2)
                temArrayPos = [temArrayPos; find(idxPos == foldsPermut(j,i))]; 
                temArrayNeg = [temArrayNeg; find(idxNeg == foldsPermut(j,i)) + (idxLimit-1)]; 
            end
            PosMatrix(:,i) = temArrayPos; 
            NegMatrix(:, i) = temArrayNeg; 
        end 
        
        trainingIdx(1:class1Instances,:) = PosMatrix(1:class1Instances, :); 
        trainingIdx(class1Instances+1 : end, :) = NegMatrix(1:class2Instances, :); 
               
        testingIdx(1:Remclass1Instances, : ) = PosMatrix(class1Instances+1:end, :); 
        testingIdx(Remclass1Instances+1 : end , :) = NegMatrix(class2Instances+1 : end, :); 
        
%         for i = 1 : nTry 
% 
%             %%% Training Idx 
%             idxFoldsPermut = foldsPermut(i,1:per);
%             tmp = [];
%             tmpPos = []; 
%             tmpNeg  = [];         
%             for j = 1:length(idxFoldsPermut)
%                 % tmp = [tmp ; find(idxNeg==idxFoldsPermut(j)) ; find(idxPos==idxFoldsPermut(j))+(idxLimit-1)];
%                 tmpNeg  = [tmpNeg ; find(idxNeg==idxFoldsPermut(j))+(idxLimit-1) ]; 
%                 tmpPos =  [tmpPos; find(idxPos==idxFoldsPermut(j))];
%             end
%             tmpNegPrimer = tmpNeg(1: length(trainingIdx)/2); 
%             tmp = [tmp; tmpPos; tmpNegPrimer]; 
%             remtemNeg = tmpNeg(length(trainingIdx)/2+1:end); 
%             trainingIdx(1:numel(tmp),i) = tmp;
% 
%             %%% TestingIdx 
% 
%             idxFoldsPermut = foldsPermut(i,per+1:10);
%             tmpNeg = [];
%             tmpPos = []; 
%             tmp = []; 
%             
%             for j = 1 : length(idxFoldsPermut)
%                 tmpNeg = [tmpNeg ; find(idxNeg == idxFoldsPermut(j)) + (idxLimit-1)]; 
%                 tmpPos = [tmpPos ; find(idxPos == idxFoldsPermut(j))]; 
%             end 
%             tmp = [tmp; tmpNeg; remtemNeg; tmpPos]; 
%             testingIdx(1: numel(tmp), i) = tmp; 
%             
% 
%         end 

   elseif  strcmpi(ClassOption, 'M_DB')
        
        label(label==labels(1)) = -1;
        label(label==labels(2)) = -1;
        label(label == labels(3)) = 1 ; 
%         [label, idxFull] = sort(label);
%         
        %%% Find the index which is splitting the dataset class1,2 and 3 
        idxLimit1 = find(labelOriginal==2, 1, 'first');
        idxLimit2 = find(labelOriginal ==1, 1, 'first'); 
             
        %%% Make cross-validation on negative example
        idxPos = crossvalind('Kfold', labelOriginal(1:idxLimit1-1), nFolds);

        %%% Make cross-validation on positive example
        idxNeg1 = crossvalind('Kfold', labelOriginal(idxLimit1:idxLimit2-1), nFolds);
        idxNeg2 = crossvalind('Kfold', labelOriginal(idxLimit2: end), nFolds); 
        
        
        class1Instances = ceil((length(idxPos)/10)*per) ; 
        class2Instances1 = ceil((length(idxNeg1)/10)*per); 
        class2Instances2 = ceil((length(idxNeg2)/10)*per); 
        
        lengthPos = length(idxPos); 
        lengthNeg1 = length(idxNeg1); 
        lengthNeg2 = length(idxNeg2); 
        
        Remclass1Instances = lengthPos - class1Instances ; 
        Remclass2Instances1 = lengthNeg1 - class2Instances1; 
        Remclass2Instances2 = lengthNeg2 - class2Instances2; 
        
        
        trainingIdx = zeros(class1Instances + class2Instances1 + class2Instances2, 10); 
        testingIdx = zeros(Remclass1Instances + Remclass2Instances1 + Remclass2Instances2, 10);
        
        PosMatrix = zeros(length(idxPos), nTry); 
        Neg1Matrix = zeros(length(idxNeg1), nTry); 
        Neg2Matrix = zeros(length(idxNeg2), nTry); 
        for i = 1 : nTry 
        temArrayPos = []; 
        temArrayNeg1 = [];
        temArrayNeg2 = []; 
            for j = 1 : size(foldsPermut,2)
                temArrayPos = [temArrayPos; find(idxPos == foldsPermut(j,i))]; 
                temArrayNeg1 = [temArrayNeg1; find(idxNeg1 == foldsPermut(j,i))+ (idxLimit1-1)]; 
                temArrayNeg2 = [temArrayNeg2; find(idxNeg2 == foldsPermut(j,i)) + (idxLimit2-1)]; 
            end
            PosMatrix(:,i) = temArrayPos; 
            Neg1Matrix(:,i) = temArrayNeg1; 
            Neg2Matrix(:,i) = temArrayNeg2; 
        end 
        
        fIndex = 1 ; lIndex = class1Instances;   
        trainingIdx(fIndex:lIndex, :) = PosMatrix(1:class1Instances, :); 
        fIndex = lIndex + 1; lIndex = lIndex + class2Instances1 ; 
        trainingIdx(fIndex:lIndex , :) = Neg1Matrix(1 : class2Instances1, :);
        fIndex = lIndex+1 ; lIndex = lIndex + class2Instances2; 
        trainingIdx(fIndex: end) = Neg2Matrix(1:class2Instances2, :); 
        
        
        fIndex = 1 ; lIndex = Remclass1Instances ; 
        testingIdx(fIndex:lIndex,:) = PosMatrix(class1Instances+1:end, :); 
        fIndex = lIndex+1 ;  lIndex = lIndex + Remclass2Instances1 ; 
        testingIdx(fIndex : lIndex, :) = Neg1Matrix(class2Instances1+1 : end, :); 
        fIndex = lIndex +1 ; 
        testingIdx(fIndex : end, :) = Neg2Matrix(class2Instances2+1: end, :); 
        
        
%         for i = 1 : nTry 
% 
%             %%% Training Idx 
%             idxFoldsPermut = foldsPermut(i,1:per);
%             tmp = [];
%             tmpPos = []; 
%             tmpNeg1  = [];  
%             tmpNeg2 = []; 
%             for j = 1:length(idxFoldsPermut)
%                 
%                 tmpPos  = [tmpPos ; find(idxPos==idxFoldsPermut(j)) ]; 
%                 tmpNeg1 =  [tmpNeg1; find(idxNeg1 ==idxFoldsPermut(j))+(idxLimit1-1)];
%                 tmpNeg2 = [tmpNeg2; find(idxNeg2 ==idxFoldsPermut(j))+ (idxLimit2-1)]; 
%             end
%             tmpNeg1Prim = tmpNeg1(1: 30); 
%             tmpNeg2Prim = tmpNeg2(1: 33); 
%             tmp = [tmp; tmpPos; tmpNeg1Prim; tmpNeg2Prim]; 
%             remtmpNeg1 = tmpNeg1(31:end); 
%             remtmpNeg2 = tmpNeg2(34:end); 
%             
%             trainingIdx(1:numel(tmp),i) = tmp;
%             clear tmp; 
%             clear tmpNeg1; clear tmpNeg2; clear tmpPos; 
% 
%             %%% TestingIdx 
% 
%             idxFoldsPermut = foldsPermut(i,per+1:10);
%             tmpNeg1 = [];
%             tmpNeg2 = []; 
%             tmpPos = []; 
%             tmp = []; 
%             for j = 1:length(idxFoldsPermut)
%                 tmpPos  =  [tmpPos ; find(idxPos==idxFoldsPermut(j)) ]; 
%                 tmpNeg1 =  [tmpNeg1; find(idxNeg1 ==idxFoldsPermut(j))+ (idxLimit1-1)];
%                 tmpNeg2 =  [tmpNeg2 ; find(idxNeg2 == idxFoldsPermut(j)) + (idxLimit2 -1)]; 
%               
%             end
%             tmp = [tmp; tmpPos; tmpNeg1; remtmpNeg1; tmpNeg2; remtmpNeg2]; 
%             testingIdx(1:numel(tmp),i) = tmp;
%         end 
%        


    elseif strcmpi (ClassOption, 'MD_B')
        
        label(label==labels(1)) = -1;
        label(label==labels(2)) = 1;
        label(label == labels(3)) = 1 ; 
                
        
        %%% Find the index which is splitting the dataset class1,2 and 3 
        idxLimit1 = find(labelOriginal==2, 1, 'first');
        idxLimit2 = find(labelOriginal ==1, 1, 'first'); 
             
        
        %%% Make cross-validation on positive example
        idxPos1 = crossvalind('Kfold', labelOriginal(1:idxLimit1-1), nFolds);
        idxPos2 = crossvalind('Kfold', labelOriginal(idxLimit1:idxLimit2-1), nFolds);

        %%% Make cross-validation on negative example        
        idxNeg = crossvalind('Kfold', labelOriginal(idxLimit2: end), nFolds); 
        
        
                
        class1Instances1 = ceil((length(idxPos1)/10)*per) ; 
        class1Instances2 = ceil((length(idxPos2)/10)*per); 
        class2Instances = ceil((length(idxNeg2)/10)*per); 
        
        lengthPos1 = length(idxPos1); 
        lengthPos2 = length(idxPos2); 
        lengthNeg = length(idxNeg); 
        
        Remclass1Instances1 = lengthPos1 - class1Instances1 ; 
        Remclass1Instances2 = lengthPos2 - class1Instances2 ; 
        Remclass2Instances = lengthNeg - class2Instances ; 
        
        trainingIdx = zeros(class1Instances1 + class1Instances2 + class2Instances, 10); 
        testingIdx = zeros(Remclass1Instances1 + Remclass1Instances2 + Remclass2Instances, 10); 
        
        Pos1Matrix = zeros(length(idxPos1), nTry); 
        Pos2Matrix = zeros(length(idxPos2), nTry); 
        NegMatrix = zeros(length(idxNeg), nTry); 
        for i = 1 : nTry 
        temArrayPos1 = []; 
        temArrayPos2 = [];
        temArrayNeg1 = []; 
            for j = 1 : size(foldsPermut,2)
                temArrayPos1 = [temArrayPos1; find(idxPos1 == foldsPermut(j,i))]; 
                temArrayPos2 = [temArrayPos2; find(idxPos2 == foldsPermut(j,i))+ (idxLimit1-1)]; 
                temArrayNeg = [temArrayNeg1; find(idxNeg == foldsPermut(j,i)) + (idxLimit2-1)]; 
            end
            Pos1Matrix(:,i) = temArrayPos1; 
            Pos2Matrix(:,i) = temArrayPos2; 
            NegMatrix(:,i) = temArrayNeg; 
        end 

        
        fIndex = 1 ; lIndex = class1Instances/2; 
        trainingIdx(1:class1Instances/2, :) = Pos1Matrix(1:class1Instances/2, :);
        fIndex = fIndex + 1;  lIndex = lIndex + class1Instances/2; 
        trainingIdx((class1Instances/2)+1 : class1Instances, :) = Pos2Matrix(1:class1Instances/2, :); 
        fIndex = lIndex +1 ; 
        trainingIdx(fIndex: end, :) = NegMatrix(1:class1Instances, :); 
        
        fIndex = 1 ; lIndex = size(Pos1Matrix, 1)- (class1Instances/2); 
        testingIdx(fIndex: lIndex, :) = Pos1Matrix(class1Instances/2 +1 : end , :); 
        fIndex = lIndex + 1;  lIndex = lIndex + size(Pos2Matrix, 1)- (class1Instances/2); 
        testingIdx(fIndex: lIndex, :) = Pos2Matrix(class1Instances/2 +1 : end , :); 
        fIndex = lIndex +1 ; 
        testingIdx(fIndex: end , :) = NegMatrix(class1Instances+1: end , :); 
        
        
%          for i = 1 : nTry 
% 
%             %%% Training Idx 
%             idxFoldsPermut = foldsPermut(i,1:per);
%             tmp = [];
%             tmpPos1 = []; 
%             tmpPos2  = [];  
%             tmpNeg = []; 
%             for j = 1:length(idxFoldsPermut)
%                 
%                 tmpPos1  = [tmpPos1 ; find(idxPos1==idxFoldsPermut(j)) ]; 
%                 tmpPos2 =  [tmpPos2; find(idxPos2 ==idxFoldsPermut(j))+(idxLimit1-1)];
%                 tmpNeg = [tmpNeg; find(idxNeg ==idxFoldsPermut(j))+ (idxLimit2-1)]; 
%             end
%             tmpPos1Prim = tmpPos1(1: 45); 
%             tmpPos2Prim = tmpPos2(1: 45); 
%             tmpNegPrim  = tmpNeg(1:90); 
%             tmp = [tmp; tmpPos1Prim; tmpPos2Prim; tmpNegPrim]; 
%             remtmpPos1 = tmpPos1(46:end); 
%             remtmpPos2 = tmpPos2(46:end); 
%             remtmpNeg = tmpNeg(90:end); 
%             trainingIdx(1:numel(tmp),i) = tmp;
%             clear tmp; 
%             clear tmpPos1; clear tmpPos2; clear tmpNeg; 
% 
%             %%% TestingIdx 
% 
%             idxFoldsPermut = foldsPermut(i,per+1:10);
%             tmpPos1 = [];
%             tmpPos2 = []; 
%             tmpNeg = []; 
%             tmp = []; 
%             for j = 1:length(idxFoldsPermut)
%                 tmpPos1  =  [tmpPos1 ; find(idxPos1==idxFoldsPermut(j)) ]; 
%                 tmpPos2 =  [tmpPos2; find(idxPos2 ==idxFoldsPermut(j))+ (idxLimit1-1)];
%                 tmpNeg =  [tmpNeg ; find(idxNeg == idxFoldsPermut(j)) + (idxLimit2 -1)]; 
%               
%             end
%             tmp = [tmp; tmpPos1; remtmpPos1; tmpPos2; remtmpPos2; tmpNeg; remtmpNeg]; 
%             testingIdx(1:numel(tmp),i) = tmp;
%         end 
       

  end 




 